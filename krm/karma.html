<!DOCTYPE html>
<!--
   Copyright 2023 Liam Breck
   Published at https://github.com/networkimprov/brangr

   This Source Code Form is subject to the terms of the Mozilla Public
   License, v. 2.0. If a copy of the MPL was not distributed with this
   file, You can obtain one at http://mozilla.org/MPL/2.0/
-->
<html><head>
   <title>Karma</title>

   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1">

   <link rel="stylesheet" href="karma.css"/>
   <!--script type="importmap">
   { "imports": { 
      "vue":     "https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.esm-browser.min.js"
   }}
   </script-->
</head><body>
<base target="_blank">

<script>
   var krm = {
      app: null,
      appRoot: null,
   };
   window.onload = () => {
      krm.appRoot = krm.app.mount('#krm-app');
   };
   if (!Array.prototype.findLast) // missing in prior Safari
      Array.prototype.findLast = function(iFn) {
         for (var a = this.length-1; a >= 0; --a)
            if (iFn(this[a]))
               return this[a];
         return null;
      };
</script>

<div id="krm-app"><div style="text-align:center; color:tan">
   <h3>Karma - Audio Wonders</h3>
   <a style="color:inherit" href="https://github.com/networkimprov/karma">Karma on Github</a>
   <p>Karma is an audio service to uplift and expand all listeners.</p>
</div></div>

<script type="text/x-template" id="krm-main">
   <finder/>
   <div style="margin-top:3em; border-top:1px solid gray; padding-left:0.5em;
               font-family:monospace; white-space:pre-wrap;">
      <a @click.prevent="debug = !debug"
         style="text-decoration:none"
         href="#debug">Debug</a>
      <div v-show="debug">{{logtxt}}</div>
   </div>
   <input ref="clipboard" style="display:none"/>
</script><script type="module">
   import * as Vue from "https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.esm-browser.min.js"

   krm.app = Vue.createApp({
      template: '#krm-main',
      data() { return { debug: false, logtxt: '', scrollPos: {}, scrollKey: null } },
      computed: {
      },
      methods: {
         log(i) { this.logtxt += '\n'+ i },
         setScroll() {
            this.scrollPos[this.scrollKey] = document.scrollingElement.scrollTop;
         },
         scrollFor(iKey) {
            iKey += '';
            document.scrollingElement.scrollTop = this.scrollPos[iKey] || 0;
            this.scrollKey = iKey;
         },
         copy(iTxt) {
            var aEl = this.$refs.clipboard;
            aEl.value = iTxt;
            aEl.style.display = 'inline';
            aEl.select();
            document.execCommand('copy');
            aEl.style.display = 'none';
         },
         xhrGet(iUrl, iFmt, iLog, iCb) {
            var aXhr = new XMLHttpRequest();
            aXhr.responseType = iFmt;
            aXhr.open('GET', iUrl);
            aXhr.onload = c => {
               if (aXhr.status !== 200) {
                  this.log(iLog +' not found: '+ iUrl);
                  return;
               }
               iCb(aXhr.response);
            };
            aXhr.onerror = c => { this.log(iLog +' "'+ iUrl +'" error: '+ c.message) };
            aXhr.send();
         },
      },
   });
</script>

<script type="text/x-template" id="krm-finder">
   <div style="padding-bottom: 0.5em; border-bottom: 1px solid gray; margin-bottom: 0.5em">
      <span @click="screen = 'fe'"
            >Feed</span> &nbsp;
      <span @click="screen = 're'"
            >Recent</span> &nbsp;
      <span @click="screen = 'ca'"
            >Categories</span>
   </div>
   <feed v-show="screen === 'fe'"
         :id="feed && feed.file" :name="feed && feed.name"/>
   <ol v-show="screen === 're'">
      <li v-for="(a, aI) in recent"
          @click="recN = aI, screen = 'fe'"
          >{{a.name}}</li>
   </ol>
   <ul v-show="screen === 'ca'">
      <li v-for="a in cats"
          >{{a.name}}</li>
   </ul>
</script><script type="module">
   import * as Vue from "https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.esm-browser.min.js"

   krm.app.component('finder', {
      template: '#krm-finder',
      data() { return { screen: 'fe', recent: null, recN: 0, cats: null } },
      computed: {
         feed() { return this.recent && this.recent[this.recN] },
      },
      created() {
         this.$root.xhrGet('Rec', 'json', 'recent list', c => { this.recent = c });
         this.$root.xhrGet('Cat', 'json', 'categories', c => { this.cats = c });
      },
   });
</script>

<script type="text/x-template" id="krm-feed">
   <div>
      <h3>
         <button @click="toggle()"
                 :disabled="state === 'off' && !nextBuf"
                 style="width:2em; float:right; margin-right:2em">
            <span v-show="state === 'run'">&#x2225;</span>
            <span v-show="state !== 'run'">&#x25b6;</span>
         </button>
         <button @click="skip()"
                 :disabled="state !== 'run'"
                 style="width:2em; float:right; margin-right:1em"
                 >&#x276f;&#x276f;</button>
         <div v-show="!nextBuf"
              style="float:right; margin-right:1em; padding:0 0.5em; background-color:lightgray"
              title="Loading clip"
              >&#x2913;</div>
         Feed {{name}} ({{id}})
      </h3>
      <ol>
         <li v-for="(a, aI) in feed"
             :style="{border: aI === feedN ? '1px solid black' : null}"
             >{{a.name}}</li>
      </ol>
   </div>
</script><script type="module">
   import * as Vue from "https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.esm-browser.min.js"

   krm.app.component('feed', {
      template: '#krm-feed',
      props: { id: String, name: String },
      data() { return { audCtx: new AudioContext(), audSrc: true, state: 'off',
                        feed: null, feedN: 0, nextBuf: null } },
      watch: {
         id() {
            this.$root.xhrGet(this.id, 'json', 'audio feed', c => {
               this.feed = c;
               this.load(this.feedN-1);
            });
         },
      },
      methods: {
         toggle() {
            switch (this.state) {
            case 'off': this.start();          this.state = 'run'; break;
            case 'run': this.audCtx.suspend(); this.state = 'sus'; break;
            case 'sus': this.audCtx.resume();  this.state = 'run'; break;
            }
         },
         skip() {
            if (this.state === 'off' || !this.audSrc) {
               this.$root.log('cannot skip when not started');
               return;
            }
            this.audSrc.stop(0);
         },
         start() {
            this.audSrc = this.audCtx.createBufferSource();
            this.audSrc.buffer = this.nextBuf;
            this.audSrc.connect(this.audCtx.destination);
            this.audSrc.onended = c => {
               this.audSrc = null;
               if (++this.feedN === this.feed.length)
                  this.feedN = 0;
               if (this.nextBuf)
                  this.start();
            };
            this.nextBuf = null;
            this.audSrc.start(0);
            this.load(this.feedN);
         },
         load(iN) {
            iN = iN+1 === this.feed.length ? 0 : iN+1;
            this.$root.xhrGet(this.feed[iN].file, 'arraybuffer', 'audio source', cResp => {
               this.audCtx.decodeAudioData(cResp, cBuf => {
                  this.nextBuf = cBuf;
                  if (!this.audSrc)
                     this.start();
               });
            });
         },
      },
   });
</script>


</body></html>
