<!DOCTYPE html>
<!--
   Copyright 2023 Liam Breck
   Published at https://github.com/networkimprov/brangr

   This Source Code Form is subject to the terms of the Mozilla Public
   License, v. 2.0. If a copy of the MPL was not distributed with this
   file, You can obtain one at http://mozilla.org/MPL/2.0/
-->
<html><head>
   <title>Karma</title>

   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1">

   <link rel="stylesheet" href="karma.css"/>
   <!--script type="importmap">
   { "imports": { 
      "vue":     "https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.esm-browser.min.js"
   }}
   </script-->
</head><body>
<base target="_blank">

<script>
   var krm = {
      app: null,
      appRoot: null,
      s: { feedRef: {}, screen: -1 },
      kSc: {fe:0, st:1, jo:2, si:3, re:1, br:2, fo:3, ci:4, dj:5, cu:6},
   };
   window.onload = () => {
      krm.appRoot = krm.app.mount('#krm-app');
   };
   if (!Array.prototype.findLast) // missing in prior Safari
      Array.prototype.findLast = function(iFn) {
         for (var a = this.length-1; a >= 0; --a)
            if (iFn(this[a]))
               return this[a];
         return null;
      };
</script>

<div id="krm-app"><div style="text-align:center; color:tan">
   <h3>Karma Audio Worlds</h3>
   <a style="color:inherit" href="https://github.com/networkimprov/karma">Karma on Github</a>
   <p>Karma is an audio service to uplift and expand all listeners.</p>
</div></div>

<script type="text/x-template" id="krm-main">
   <div style="margin-top:3em"></div>
   <feed v-show="krm.s.screen === krm.kSc.fe"
         @godj="function(c) { if ($refs.finder) $refs.finder.goDj(c) }"
         :id="krm.s.feedRef.id" :name="krm.s.feedRef.name"
         :go="firstStart"
         ref="feed"/>
   <start v-if="firstStart"
          @ok="firstStart = false"/>
   <finder v-else
           @djadd="function(c) { $refs.feed.addDj(c) }"
           ref="finder"/>
   <div style="margin-top:3em; border-top:1px solid gray; padding-left:0.5em;
               font-family:monospace; white-space:pre-wrap;">
      <a @click.prevent="debug = !debug"
         style="text-decoration:none"
         href="#debug">Debug</a>
      <div v-show="debug">{{logtxt}}</div>
   </div>
   <input ref="clipboard" style="display:none"/>
</script><script type="module">
   import * as Vue from "https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.esm-browser.min.js"

   krm.s = Vue.reactive(krm.s);

   krm.app = Vue.createApp({
      template: '#krm-main',
      data() { return { debug: false, logtxt: '', scrollPos: {}, scrollKey: null,
                        firstStart: location.search === '?start' } },
      computed: {
         krm() { return krm },
      },
      methods: {
         log(i) { this.logtxt += '\n'+ i },
         setScroll() {
            this.scrollPos[this.scrollKey] = document.scrollingElement.scrollTop;
         },
         scrollFor(iKey) {
            iKey += '';
            document.scrollingElement.scrollTop = this.scrollPos[iKey] || 0;
            this.scrollKey = iKey;
         },
         copy(iTxt) {
            var aEl = this.$refs.clipboard;
            aEl.value = iTxt;
            aEl.style.display = 'inline';
            aEl.select();
            document.execCommand('copy');
            aEl.style.display = 'none';
         },
         xhrGet(iUrl, iFmt, iLog, iCb) {
            var aXhr = new XMLHttpRequest();
            aXhr.responseType = iFmt;
            aXhr.open('GET', iUrl);
            aXhr.onload = c => {
               if (aXhr.status !== 200) {
                  this.log(iLog +' not found: '+ iUrl);
                  return;
               }
               iCb(aXhr.response);
            };
            aXhr.onerror = c => { this.log(iLog +' "'+ iUrl +'" error: '+ c.message) };
            aXhr.send();
            return aXhr;
         },
      },
   });
</script>

<script type="text/x-template" id="krm-start">
   <div style="position:fixed; left:0.5em; right:0.5em; top:0;
               padding: 0.5em 0; border-bottom: 1px solid gray; background-color:#fff">
      <span v-if="select"
            @click="krm.s.screen = krm.kSc.st"
            class="uipoint uibold"
            >Karma Audio {{select === 2 ? '- Sampler' : ''}}</span>
      <span v-else
            @click="krm.s.screen = krm.kSc.fe"
            class="uipoint uibold"
            >Karma Audio - Welcome!</span>
      <div style="position:absolute; right:0; top:0.5em">
         <span v-if="!select"
               @click="krm.s.screen = krm.kSc.jo"
               class="uipoint tabmargr uibold" :class="{tabshow: krm.s.screen === krm.kSc.jo}"
               >Join Karma</span>
         <span @click="krm.s.screen = krm.kSc.si"
               class="uipoint" :class="{tabshow: krm.s.screen === krm.kSc.si}"
               >Sign In</span>
      </div>
   </div>
   <div v-if="select"
        v-show="krm.s.screen === krm.kSc.st">
      <template v-if="select === 1">
         <div style="float:left; margin-right:0.5em; height:64px;
                     border:2px solid lightgray; border-radius:50%; background-color:#2020aa;
                     padding:8px; font-size:32px; color:white">
            <span style="vertical-align:middle">KmA</span></div>
         <div style="padding-top:1em; font-style:italic"
              >Where the World Hears Wonders &amp; Wisdom</div>
         <span @click="select = 2"
               class="uipoint uibold"
               >Try It!</span>
      </template>
      <template v-else>
         <div style="margin-bottom:1em"
              >Select some topics of interest for your first feed<br/>
               (You can add or amend feeds anytime.)
         </div>
         <button @click="krm.s.screen = krm.kSc.fe, select = 0, getMix()"
                 style="float:right; margin-right:2em"
                 >&#x25b6; Listen</button>
         <table><tr>
            <td v-for="aCol in cats">
               <div v-for="a in aCol">
                  <label><input type="checkbox" :name="a.name"/>{{a.name}}</label>
               </div></td></tr></table>
      </template>
   </div>
   <div v-show="krm.s.screen === krm.kSc.jo">
      Full name or alias<br/>
      <input type="text" style="width:12em"/><br/>
      <button @click="$emit('ok')"
              >Sign Up</button>
   </div>
   <div v-show="krm.s.screen === krm.kSc.si">
      <table><tr>
         <td>Account</td>
         <td><input type="text" value="longUserId"
                    style="width:12em"/></td>
      </tr><tr>
         <td>Key</td>
         <td><input type="text" value="randomKey"
                    style="width:12em"/></td>
      </tr></table>
      <button @click="$emit('ok')"
              >Sign In</button>
   </div>
</script><script type="module">
   import * as Vue from "https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.esm-browser.min.js"

   krm.app.component('start', {
      template: '#krm-start',
      emits: ['ok'],
      data() { return { select: 1, cats: null } },
      computed: {
         krm() { return krm },
      },
      created() {
         krm.s.screen = krm.kSc.st;
         this.$root.xhrGet('Cat', 'json', 'categories',  c => { this.cats = c });
      },
      methods: {
         getMix() { this.$root.xhrGet('Mix', 'json', 'audio feed', c => { krm.s.feedRef = c }) },
      },
   });
</script>

<script type="text/x-template" id="krm-finder">
   <div style="position:fixed; left:0.5em; right:0.5em; top:0;
               padding: 0.5em 0; border-bottom: 1px solid gray; background-color:#fff">
      <span @click="krm.s.screen = krm.kSc.fe"
            class="uipoint tabmargr" :class="{tabshow: krm.s.screen === krm.kSc.fe}"
            >Feed</span>
      <span @click="krm.s.screen = krm.kSc.re"
            class="uipoint tabmargr" :class="{tabshow: krm.s.screen === krm.kSc.re}"
            >Recent</span>
      <span @click="krm.s.screen = found ? krm.kSc.fo : krm.kSc.br"
            class="uipoint tabmargr" :class="{tabshow: krm.s.screen === (found ? krm.kSc.fo : krm.kSc.br)}"
            >Browse</span>
      <span @click="krm.s.screen = krm.kSc.ci"
            class="uipoint tabmargr" :class="{tabshow: krm.s.screen === krm.kSc.ci}"
            >Circles</span>
      <span v-show="!!djs"
            @click="krm.s.screen = krm.kSc.dj"
            class="uipoint tabmargr" :class="{tabshow: krm.s.screen === krm.kSc.dj}"
            >DJs</span>
      <div style="position:absolute; right:0; top:0.5em">
         <span v-if="act && act.curate" k--="todo: menu if multiple curators"
               @click="krm.s.screen = krm.kSc.cu, goCurate(act.curate[0])"
               class="uipoint tabmargr" :class="{tabshow: krm.s.screen === krm.kSc.cu}"
               >Curate</span>
      </div>
   </div>
   <div v-show="krm.s.screen === krm.kSc.re">
      <div class="tabset2">
         <span @click="recSaved = false"
               :class="{tabshow: !recSaved}"
               >Played</span>
         <span @click="recSaved = true"
               :class="{tabshow: recSaved}"
               >Saved</span>
      </div>
      <div v-show="recSaved">
         <button @click="addFeed()"
                 style="float:right"
                 >&#x2795;</button></div>
      <table v-if="act"
             style="border-spacing:1em 1px">
         <tr><th></th> <th>{{recSaved ? 'Revised' : 'Last played'}}</th> <th>Scheduled</th> <th>DJs</th></tr>
         <tr v-for="a in (recSaved ? act.saved : act.played)" :key="a.id">
            <td><span @click="setPlayed(a), krm.s.screen = krm.kSc.fe"
                      class="uipoint uibold"
                      >{{a.name}}</span></td>
            <td>{{recSaved ? a.saved : a.played}}</td>
            <td>{{a.schedule}}</td>
            <td><span v-for="aDj in a.djs"
                      style="margin-right:0.5em; padding:0 0.25em 0.1em; background-color:lightgray"
                      >{{aDj.name}}</span></td>
         </tr>
      </table>
   </div>
   <button v-show="krm.s.screen === krm.kSc.br"
           @click="krm.s.screen = krm.kSc.fo, goBrowse()"
           style="float:right; margin-right:1em"
           >Find DJs</button>
   <table v-show="krm.s.screen === krm.kSc.br"><tr>
      <td v-for="aCol in cats">
         <div v-for="a in aCol">
            <label><input type="checkbox" :name="a.name"/>{{a.name}}</label>
         </div></td></tr></table>
   <button v-show="krm.s.screen === krm.kSc.fo"
           @click="krm.s.screen = krm.kSc.br, found = null"
           style="float:right; margin-right:2em; width:2em"
           >&times;</button>
   <div v-show="krm.s.screen === krm.kSc.fo">
      <div v-show="!found"
           >Looking...</div>
      <table v-show="found"
             style="border-spacing:1em 0">
         <tr><th></th><th>Last Program</th><th>Clips</th><th>Run time</th></tr>
         <tr v-for="a in found">
            <td><span @click="goDj(a.id)"
                      class="uipoint uibold"
                      >{{a.name}}</span></td>
            <td>{{a.last}}</td>
            <td>{{a.count}}</td>
            <td>{{a.dur}}</td>
         </tr></table>
   </div>
   <div v-show="krm.s.screen === krm.kSc.ci" v-if="circ"
        style="margin-right:0.5em">
      <span v-for="a in circ.circles"
            v-show="!thread || a.id === thread.circle"
            style="margin-right:0.5em; padding:0.25em; background-color:lightgray"
            :title="memlist(a.members)"
            >{{a.name}} ({{a.members.length}})</span>
      <table v-show="!thread"
             style="margin-top:1em; border-spacing:1em 0.25em">
         <tr v-for="a in circ.threads">
            <td>{{a.isNew ? '\u2600' : ' '}}</td>
            <td>{{a.date}}</td>
            <td>{{circName(a.circle)}}</td>
            <td>{{a.count}}</td>
            <td><span @click="goThread(a)"
                      class="uipoint uibold"
                      >{{a.topic}}</span></td>
         </tr></table>
      <div v-show="thread"
           style="margin:1em 0 0.5em">
         <span @click="thread = null"
               class="uipoint uibold" style="margin-right:0.25em; padding:0 0.5em"
               >&#x276e;</span>
         <span class="uibold tabmargr"
               >{{thread && thread.topic}}</span>
         <span >({{thread && thread.count}})</span>
      </div>
      <table v-show="thread"
             style="border-spacing:1em 0.2em">
         <tr v-for="a in (thread && msgMap[thread.id])">
            <td>{{a.date}}</td>
            <td>{{a.alias}}</td>
            <td><span v-for="aTg in a.tags"
                      style="margin-right:0.25em; padding:2px; background-color:#f8f8aa"
                      >{{aTg}}</span></td>
            <td>{{a.runtime}}</td>
            <td><button @click=""
                        >&#x25b6;</button></td>
         </tr></table>
   </div>
   <div v-show="krm.s.screen === krm.kSc.dj"
        style="margin-right:0.5em">
      <div class="tabset2">
         <span v-for="(a, aI) in djs"
               @click="djN = aI"
               :class="{tabshow: djN === aI}"
               >{{a.name}}</span>
      </div>
      <div v-for="(a, aI) in djs"
           v-show="aI === djN">
         <img :src="a.img"
              style="float:right; margin:0 0 0.5em 0.5em; max-width:25%"/>
         <select @change="addFeedDj($event.target.value, a), $event.target.value = ''"
                 style="float:right; clear:right">
            <option value=""
                    >&#x2795; to Feed...</option>
            <option value="new"
                    >New Feed</option>
            <option v-for="aF in act.saved"
                    :value="aF.id"
                    >{{aF.name}}</option>
         </select>
         <h3>{{a.name}}</h3>
         <div style="margin-bottom:0.5em; font-style:italic"
              >{{a.title}}</div>
         Programs
         <table style="margin-left:1em; border-spacing:1em 0">
            <tr v-for="aP in a.progs">
               <td>{{aP.date}}</td>
               <td>{{aP.name}}</td>
               <td>{{aP.count}}</td>
               <td>{{aP.dur}}</td>
            </tr></table>
      </div>
   </div>
   <div v-if="curId in curate"
        v-show="krm.s.screen === krm.kSc.cu"
        style="margin-right:0.5em">
      <div class="tabset2">
         <span @click="progN = -2"
               :class="{tabshow: progN === -2}"
               >Home</span>
         <span @click="progN = -1"
               :class="{tabshow: progN === -1}"
               >Library</span>
         <span v-for="(a, aI) in curate[curId].progs"
               @click="progN = aI"
               :class="{tabshow: progN === aI}"
               >{{a.name}}</span>
      </div>
      <div v-show="progN === -2">
         <img :src="curate[curId].img"
              style="float:right; margin-left:0.5em; max-width:25%"/>
         <h3>{{curate[curId].name}} ({{curate[curId].id}})</h3>
         <div style="margin-bottom:1em; font-style:italic"
              >{{curate[curId].title}}</div>
         <table style="margin-bottom:1em; border-spacing:1em 0">
            <tr><td><button @click="addProg()"
                            >&#x2795;</button></td></tr>
            <tr><th></th><th>Date</th><th>Count</th><th>Runtime</th><th>Draft</th></tr>
            <tr v-for="(a, aI) in curate[curId].progs">
               <td><span @click="progN = aI"
                         class="uipoint uibold"
                         >{{a.name}}</span></td>
               <td>{{a.date}}</td>
               <td class="uialignr"
                   >{{a.count}}</td>
               <td class="uialignr"
                   >{{a.dur}}</td>
               <td>{{a.draft ? '*' : ''}}</td>
            </tr>
         </table>
      </div>
      <div v-show="progN === -1">
         <table style="border-spacing:1em 0">
            <tr><td><button @click="addClip()"
                            >&#x2795;</button></td></tr>
            <tr><th></th><th>Artist</th><th>Released</th><th>Runtime</th></tr>
            <template v-for="aC in curLibSort">
               <tr>
                  <td>{{aC.name}}</td>
                  <td>{{aC.artist}}</td>
                  <td>{{aC.date}}</td>
                  <td class="uialignr"
                      >{{aC.dur}}</td>
                  <td><button @click=""
                              >&#x25b6;</button></td>
               </tr>
               <tr v-for="(aSub, aSubi) in aC.set">
                  <td colspan="3"
                      >&nbsp; {{aSubi+1}}. <em>{{aSub.name}}</em></td>
                  <td class="uialignr"
                      >{{aSub.dur}}</td>
                  <td><button @click=""
                              >&#x25b6;</button></td>
               </tr>
            </template>
         </table>
      </div>
      <div v-for="(aP, aPi) in curate[curId].progs" k--="todo: iterate over open progs"
           v-show="progN === aPi">
         <table style="border-spacing:1em 0">
            <tr>
               <td colspan="5">
                  <select @change="addProgClip(aP, $event.target.value), $event.target.value = ''">
                     <option value="">&#x2795; Clip...</option>
                     <template v-for="(aV, aK) in curate[curId].clips">
                        <option :value="aK"
                                >{{aV.name}}, {{aV.artist}}</option>
                        <option v-for="(aSub, aSubi) in aV.set"
                                :value="aK +'.'+ aSubi"
                                >&nbsp; {{aSubi+1}}. <em>{{aSub.name}}</em></option>
                     </template>
                  </select></td></tr>
            <tr v-if="aP.clips">
               <th>Title</th><th>Artist</th><th>Released</th><th>Runtime</th></tr>
            <tr v-else>
               <th>(No clips)</th></tr>
            <tr v-for="a in (aP.clips && aP.clips.map(getClip))">
               <td>{{a.name}}</td>
               <td>{{a.artist}}</td>
               <td>{{a.date}}</td>
               <td class="uialignr"
                   >{{a.dur}}</td>
               <td><button @click=""
                           >&#x25b6;</button></td>
            </tr>
         </table>
      </div>
   </div>
</script><script type="module">
   import * as Vue from "https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.esm-browser.min.js"

   krm.app.component('finder', {
      template: '#krm-finder',
      emits: [ 'djadd' ],
      data() { return { act: null, recSaved: false,
                        circ: null, msgMap: {}, thread: null,
                        cats: null, found: null,
                        djs: null, djN: 0,
                        curate: {}, curId: '', progN: -2 } },
      computed: {
         curLibSort() {
            return Object.values(this.curate[this.curId].clips).sort(
               (cA, cB) => cA.date > cB.date ? -1 : cA.date < cB.date ? 1 : 0
            );
         },
         krm() { return krm },
      },
      created() {
         krm.s.screen = krm.kSc.fe;
         this.$root.xhrGet('Act', 'json', 'account',     c => { this.act = c });
         this.$root.xhrGet('Cat', 'json', 'categories',  c => { this.cats = c });
         this.$root.xhrGet('Cir', 'json', 'circles',     c => { this.circ = c });
      },
      watch: {
         'act.played': {
            deep: true,
            handler() { krm.s.feedRef = this.act.played[0] }
         },
      },
      methods: {
         setPlayed(iFeed) {
            var aPos = this.act.played.findIndex(c => c.id === iFeed.id);
            if (aPos === 0)
               return;
            if (aPos > 0)
               this.act.played.splice(aPos, 1);
            this.act.played.unshift(iFeed);
            this.act.played[0].played = 'Today';
         },
         addFeed() {
            this.act.saved.unshift({name: 'Untitled', id: 'Fxx', saved: 'Today', played: null,
                                    schedule: null, djs: []});
         },
         addFeedDj(iFeed, iDj) {
            if (!iFeed)
               return;
            var aDj = {name: iDj.name, id: iDj.id};
            if (iFeed === 'new')
               this.addFeed();
            else if (iFeed === krm.s.feedRef.id)
               this.$emit('djadd', aDj);
            else
               ; //todo: update feed
            var aSaved = iFeed === 'new' ? this.act.saved[0] : this.act.saved.find(c => c.id === iFeed);
            aSaved.djs.push(aDj);
            aSaved.saved = 'Today';
            this.act.saved.sort((cA, cB) => cA.saved > cB.saved ? -1 : cA.saved < cB.saved ? 1 : 0);
         },
         goBrowse() {
            this.$root.xhrGet('Fnd', 'json', 'found', c => { this.found = c });
         },
         goThread(iRef) {
            if (iRef.id in this.msgMap)
               this.thread = iRef;
            else
               this.$root.xhrGet(iRef.id, 'json', 'thread', c => {
                  this.msgMap[iRef.id] = c;
                  this.thread = iRef;
               });
         },
         goDj(iId) {
            const fGo = () => {
               this.djN = this.djs.findIndex(c => c.id === iId);
               krm.s.screen = krm.kSc.dj;
            };
            if (this.djs)
               fGo();
            else
               this.$root.xhrGet('Djs', 'json', 'djs', c => {
                  this.djs = c;
                  fGo();
               });
         },
         goCurate(iId) {
            if (iId in this.curate)
               this.curId = iId;
            else
               this.$root.xhrGet(iId, 'json', 'curator', c => {
                  this.curate[iId] = c;
                  this.curId = iId;
               });
         },
         memlist(i) {
            var a = '';
            i.forEach(c => { a += c.name +'\n' });
            return a;
         },
         circName(i) {
            var aC = this.circ.circles.find(c => c.id === i);
            if (!aC)
               this.$root.log('circle id missing: '+ i);
            return aC ? aC.name : '??';
         },
         addProg() {
            this.curate[this.curId].progs.unshift(
               {name: 'Untitled', date: 'Today', draft: true, count: 0, dur: 0, clips: null});
         },
         addClip() {
            this.curate[this.curId].clips['Clu'+ Object.values(this.curate[this.curId].clips).length] =
               {name: 'Unknown', artist: 'self', date: 'Today', dur: 0, file: ''};
         },
         addProgClip(iP, iC) {
            if (!iC)
               return;
            if (!iP.clips)
               iP.clips = [];
            iP.clips.unshift(iC);
         },
         getClip(iId) {
            var aDot = iId.indexOf('.');
            if (aDot < 0)
               return this.curate[this.curId].clips[iId];
            var aPkg = this.curate[this.curId].clips[iId.substring(0, aDot)];
            var aSub = aPkg.set[iId.substring(aDot+1)*1];
            return {name: aSub.name, artist: aPkg.artist, date: aPkg.date, dur: aSub.dur, file: aSub.file};
         },
      },
   });
</script>

<script type="text/x-template" id="krm-feed">
   <div>
      <div v-if="feed"
           style="margin:0 0.5em 1em 0">
         DJs
         <span v-for="a in feed.curators"
               @click="$emit('godj', a.id)" k--="todo: popup dj profile card on firstStart"
               class="uipoint" style="margin-right:0.5em; padding:0.25em; background-color:lightgray"
               >{{a.name}}</span>
      </div>
      <h3>
         <button @click="toggle()"
                 :disabled="state === 'off' && !nextBuf"
                 style="width:2em; float:right; margin-right:2em">
            <span v-show="state === 'run'">&#x2225;</span>
            <span v-show="state !== 'run'">&#x25b6;</span>
         </button>
         <button @click="skip()"
                 :disabled="state !== 'run'"
                 style="width:2em; float:right; margin-right:1em"
                 >&#x276f;&#x276f;</button>
         <div v-show="!nextBuf"
              style="float:right; margin-right:1em; padding:0 0.5em; background-color:lightgray"
              title="Loading clip"
              >&#x2913;</div>
         {{name}} ({{id}})
      </h3>
      <table v-if="feed"
             style="border-spacing:1em 0">
         <tr><th></th><th>Artist</th><th>DJ</th><th>Released</th><th>Runtime</th></tr>
         <tr v-for="(a, aI) in feed.clips"
             :style="{outline: aI === clipsN ? '1px solid black' : null}">
            <td>{{a.name}}</td>
            <td>{{a.artist}}</td>
            <td>{{feed.curators.find(c => c.id === a.dj).name}}</td>
            <td>{{a.date}}</td>
            <td class="uialignr"
                >{{a.dur}}</td>
         </tr>
      </table>
   </div>
</script><script type="module">
   import * as Vue from "https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.esm-browser.min.js"

   krm.app.component('feed', {
      template: '#krm-feed',
      emits: [ 'godj' ],
      props: { id: String, name: String, go: Boolean },
      data() { return { audCtx: new AudioContext(), audSrc: null, state: 'run',
                        feed: null, clipsN: 0,
                        xhr: null, nextBuf: null } },
      created() {
         if (!this.go) {
            this.audSrc = true;
            this.state = 'off';
         }
      },
      watch: {
         id() {
            const fGet = () => {
               this.xhr = this.$root.xhrGet(this.id, 'json', 'audio feed', c => {
                  this.xhr = null;
                  this.feed = c;
                  this.load(this.clipsN-1);
               });
            };
            if (this.xhr) {
               this.xhr.abort();
               this.xhr = null;
            }
            this.nextBuf = null;
            if (!this.feed || this.state === 'off') {
               fGet();
            } else {
               if (this.audSrc)
                  this.audSrc.stop();
               if (this.state === 'sus')
                  this.audCtx.resume();
               this.state = 'off';
               setTimeout(() => { // wait for audSrc.onended to run
                  this.clipsN = 0;
                  this.audSrc = true;
                  fGet();
               }, 300);
            }
         },
      },
      methods: {
         toggle() {
            switch (this.state) {
            case 'off': this.start();          this.state = 'run'; break;
            case 'run': this.audCtx.suspend(); this.state = 'sus'; break;
            case 'sus': this.audCtx.resume();  this.state = 'run'; break;
            }
         },
         skip() {
            if (this.state === 'off' || !this.audSrc) {
               this.$root.log('cannot skip when not started');
               return;
            }
            this.audSrc.stop(0);
         },
         start() {
            this.audSrc = this.audCtx.createBufferSource();
            this.audSrc.buffer = this.nextBuf;
            this.audSrc.connect(this.audCtx.destination);
            this.audSrc.onended = c => {
               this.audSrc = null;
               if (++this.clipsN === this.feed.clips.length)
                  this.clipsN = 0;
               if (this.nextBuf)
                  this.start();
            };
            this.nextBuf = null;
            this.audSrc.start(0);
            this.load(this.clipsN);
         },
         load(iN) {
            iN = iN+1 === this.feed.clips.length ? 0 : iN+1;
            this.xhr = this.$root.xhrGet(this.feed.clips[iN].file, 'arraybuffer', 'audio source', cResp => {
               this.xhr = null;
               this.audCtx.decodeAudioData(cResp, cBuf => {
                  this.nextBuf = cBuf;
                  if (!this.audSrc)
                     this.start();
               });
            });
         },
         addDj(i) {
            if (this.feed.curators.find(c => c.id === i.id))
               return;
            this.feed.curators.push(i);
         },
      },
   });
</script>


</body></html>
